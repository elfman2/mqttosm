<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>OpenStreetMap &amp; OpenLayerss - Marker Example</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
   integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
   crossorigin=""></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
	<script>
    /* OSM & OL example code provided by https://mediarealm.com.au/ */
    var map;
    var mapLat = 44.6068;
	var mapLng = 6.2067;
//    var mapDefaultZoom = 22;
	var markers = {};
	
	var saricon;
	var droneicon;
	var climbericon;
	
    function initialize_map() {
		map = L.map("map").setView([mapLat,mapLng]);
		L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/outdoors-v11/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoibmljbzc3NyIsImEiOiJjank1aXoxOWQwN2U4M21sZXZ5emdpYWtsIn0.Yh03GxMvZzeE_A3J7IM9gg', {
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		accessToken: 'pk.eyJ1Ijoibmljbzc3NyIsImEiOiJjank1aXoxOWQwN2U4M21sZXZ5emdpYWtsIn0.Yh03GxMvZzeE_A3J7IM9gg'
	}).addTo(map);


	if (L.Browser.android) {
	
		saricon = L.icon({
			iconUrl: 'SAR.svg',
			iconSize: [60, 60],
			popupAnchor: [0, -30],
			tooltipAnchor:[30,0]
		});
		droneicon = L.icon({
			iconUrl: 'drone.svg',
			iconSize: [60, 60],
			popupAnchor: [0, -30],
			tooltipAnchor:[30,0]
		});
		climbericon = L.icon({
			iconUrl: 'climber.svg',
			iconSize: [60, 60],
			popupAnchor: [0, -30],
			tooltipAnchor:[30,0]
		});
	}else{
		saricon = L.icon({
			iconUrl: 'SAR.svg',
			iconSize: [30, 30],
			popupAnchor: [0, -15],
		});
		droneicon = L.icon({
			iconUrl: 'drone.svg',
			iconSize: [30, 30],
			popupAnchor: [0, -15],
			tooltipAnchor:[10,0]
		});
		climbericon = L.icon({
			iconUrl: 'climber.svg',
			iconSize: [30, 30],
			popupAnchor: [0, -15],
		});

	}


    }

    function add_map_point(type,ident,lat, lng) {
    	if (ident in  markers ){
    		markers[ident].remove(map);
    	}
		var marker_icon = type==="HC" ? saricon : type==="UAV" ? droneicon : climbericon;
		var marker = L.marker([parseFloat(lat),parseFloat(lng)],{icon:marker_icon}).addTo(map);
		var string = "<b>"+ident+"</b>";
		if (L.Browser.android){
			string = '<div style="font-size:200%">'+string+'</div>';
		}		
		var ttip = L.tooltip({direction:"right"}).setContent(string);
		marker.bindTooltip(ttip).openTooltip();
		markers[ident] = marker;
    }

	var client;

	function mqtt_connect(){
		// Create a client instance
		client = new Paho.MQTT.Client("test.mosquitto.org", 8081, "maps-"+Date.now());
	
		// set callback handlers
		client.onConnectionLost = onConnectionLost;
		client.onMessageArrived = onMessageArrived;

		// connect the client
		client.connect({onSuccess:onConnect, useSSL: true});
	}

	// called when the client connects
	function onConnect() {
	  // Once a connection has been made, make a subscription and send a message.
	  console.log("onConnect");
	  client.subscribe("/obj/+");
	}

	// called when the client loses its connection
	function onConnectionLost(responseObject) {
	  if (responseObject.errorCode !== 0) {
		console.log("onConnectionLost:"+responseObject.errorMessage);
	  }
	}

	// called when a message arrives
	function onMessageArrived(message) {
	  obj = JSON.parse(message.payloadString);
	  console.log("onMessageArrived: "+obj.type+" / "+obj.ident+" lat"+obj.lat+" long" +obj.long); 
	  add_map_point(obj.type,obj.ident,obj.lat,obj.long); 
	}

	function onUnload(){
		client.disconnect();
	}

  </script>
</head>
<body onload="initialize_map(); mqtt_connect(); " onunload="onUnload();">
  <div id="map" style="width: 100vw; height: 100vh;"></div>
</body>
</html>
